@(title: String)

<!DOCTYPE html>
<html>
    <head>
        <title>@title</title>
        <link rel="stylesheet" media="screen" href="@routes.Assets.at("stylesheets/main.css")">
        <link rel="shortcut icon" type="image/png" href="@routes.Assets.at("images/favicon.png")">
        <script>
        	var GameSocketHandler = function(game, uri, name)
        	{
        		var self = this;

                this.game = game;
        		this.name = name;
        		this.socket = new WebSocket(uri + "/" + name);
        		
        		this.socket.onopen = function(event) { self.onOpen.call(self, event) };
			    this.socket.onclose = function(event) { self.onClose.call(self, event) };
			    this.socket.onerror = function(event) { self.onError.call(self, event) };
			    this.socket.onmessage = function(event) { self.onMessage.call(self, event) };
        	};
        	
        	GameSocketHandler.prototype.onOpen = function(event)
        	{
        		console.log("Recieved Open");
        	};
        	
        	GameSocketHandler.prototype.onClose = function(event)
        	{
        		console.log("Recieved Close");
        	};
        	
        	GameSocketHandler.prototype.onError = function(event)
        	{
        		console.log("Recieved Error");
        	};
        	
        	GameSocketHandler.prototype.doMessage = function(id, action, message)
        	{
        		console.log("Sending " + action);
        		this.socket.send(JSON.stringify({"id": id, "action": action, "name": this.name, "message": message}));
        	};
        	
        	GameSocketHandler.prototype.onMessage = function(event)
        	{
                var data = JSON.parse(event.data);
        		var id = data.id;
                var time = data.time;
                var action = data.action;
        		var message = data.message;

                console.log("Recieved " + action);

        		switch(action)
        		{
        			case "Ping":
                        this.game.onPing(message, id, time); break;
        			case "Pong":
                        this.game.onPong(message, id, time); break;
                    case "Join":
                        this.game.onJoin(message, id, time); break;
                    case "Welcome":
                        this.game.onWelcome(message, id, time); break;
                    case "Direction":
                        this.game.onTurn(message, id, time); break;
                    case "Leave":
                        this.game.onLeave(message, id, time); break;
                    case "Death":
                        this.game.onDeath(message, id, time); break;
                    default:
                        console.log(data);
        		}
        	};

            var GameHandler = function()
            {
                var self = this;
                var body = document.getElementsByTagName("body")[0];

                this.name = window.prompt();
                this.canvas = document.createElement("canvas");

                if (this.canvas.getContext)
                {
                    this.canvas.setAttribute("style", "width:" + window.innerWidth + "px;height:" + window.innerHeight + "px;");
                    this.canvas.appendChild(document.createTextNode("HTML5 unsupported in browser."));

                    body.appendChild(this.canvas);

                    this.context = this.canvas.getContext("2d");
                    this.socket = new GameSocketHandler(this, "ws://localhost:9000/game/connect", this.name);
                    this.players = [];

                    window.onkeyup = function(event){ if ((event.keyCode == 37) || (event.keyCode == 39)) { self.doTurn.call(self, null, 0); } };
                    window.onkeydown = function(event){ if ((event.keyCode == 37) || (event.keyCode == 39)) { self.doTurn.call(self, null, ((event.keyCode == 37) ? -1 : 1)); } };
                    window.setInterval(function(){ self.draw.call(self); }, 20); // 50Hz
                }
                else
                {
                    body.appendChild(document.createTextNode("HTML5 unsupported in browser."));
                }
            };

            GameHandler.prototype.findPlayer = function(player)
            {
                var name = (player !== undefined) ? player.name : this.name;

                for (var i in this.players)
                {
                    if (this.players[i].name == name)
                    {
                        return this.players[i];
                    }
                }

                return null;
            };

            GameHandler.prototype.draw = function()
            {
                this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.drawPlayers();
            };

            GameHandler.prototype.drawBoard = function()
            {

            };

            GameHandler.prototype.drawPlayers = function()
            {
                for (var i in this.players)
                {
                    var player = this.players[i];

                    if (!player.alive)
                    {
                        continue;
                    }

                    var position = this.calculatePosition(player);

                    this.context.beginPath();

                    this.context.arc(position.x, position.y, 5, 0, Math.PI*2, false);
                    //this.context.moveTo(position.x, position.y);
                    this.context.fillStyle = player.color;
                    this.context.fill();

                    this.context.closePath();

                    //for (var n in player.arcs)
                    //{
                    //    var arc = player.arcs[n];

                    //    this.context.beginPath();

                    //    this.context.closePath();
                    //}
                }
            };

            GameHandler.prototype.calculatePosition = function(player)
            {
                var now = Date.now();
                var diff = now - player.time;

                //var x = player.x + Math.cos(player.a) * player.v * diff;
                // TODO: Extrapolate position

                return {"x": player.x, "y": player.y};
            };

            GameHandler.prototype.onWelcome = function(message)
            {
                for (var player in message.players)
                {
                    this.players.push(new Player(message.players[player]))
                }
            };

            GameHandler.prototype.onJoin = function(message)
            {
                this.players.push(new Player(message.player))
            };

            GameHandler.prototype.onPing = function(message, id)
            {
                this.doPong(id);
            };

            GameHandler.prototype.doPing = function(id)
            {
                this.socket.doMessage(id, "Ping", {});
            };

            GameHandler.prototype.onPong = function(message)
            {
                console.log(JSON.stringify(message));
            };

            GameHandler.prototype.doPong = function(id)
            {
                this.socket.doMessage(id, "Pong", {});
            };

            GameHandler.prototype.onTurn = function(message, id, time)
            {
                var him = this.findPlayer(message.player);

                him.update(message.player, message.part, time);
            };

            GameHandler.prototype.doTurn = function(id, direction)
            {
                var me = this.findPlayer();

                if (me.direction === direction)
                {
                    return;
                }

                me.direction = direction;

                this.socket.doMessage(id, "Direction", {"direction": direction});
            };

            GameHandler.prototype.onLeave = function(message)
            {
                for (var i in this.players)
                {
                    if (this.players[i].name == message.player.name)
                    {
                        delete this.players[i];
                    }
                }
            };

            GameHandler.prototype.doReady = function(id)
            {
                this.socket.doMessage(id, "Ready", {});
            };

            GameHandler.prototype.onDeath = function(message)
            {
                for (var i in message.players)
                {
                    this.findPlayer(message.players[i]).alive = false;
                }
            };

            var Player = function(player)
            {
                this.x = 0; // X-position
                this.y = 0; // Y-position
                this.a = 0.0; // Angle of direction
                this.r = 0; // Radius (should be constant and same for all players)
                this.v = 0; // Velocity
                this.arcs = []; // The arcs performed by the player during the game
                this.time = Date.now(); // Last update of player (used for extrapolation)
                this.name = player.name;
                this.color = player.color;
                this.alive = true;
                this.direction = 0; // Current direction (-1 = left, 0 = straight, 1 = right)
            };

            Player.prototype.update = function(player, part, time)
            {
                this.x = player.x;
                this.y = player.y;
                this.r = player.r;
                this.v = player.v;
                this.time = time;
                this.direction = player.direction;

                this.arcs.push(part);
            };
        </script>
    </head>
    <body>
        <script defer="defer">
            var game = new GameHandler();
        </script>
    </body>
</html>
